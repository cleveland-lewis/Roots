name: UI & UX Tests
permissions:
  contents: read

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  macos-ui:
    name: macOS UI Tests
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "Cloning repository into $GITHUB_WORKSPACE"
          rm -rf "$GITHUB_WORKSPACE"/* || true
          git clone --depth=1 "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" "$GITHUB_WORKSPACE"
          echo "Repository cloned."
      - name: Select Xcode
        run: |
          echo "Requested Xcode: latest-stable"
          echo "Available Xcode installs:"
          ls /Applications || true
          echo "xcode-select path: $(xcode-select -p)" || true
      - name: Install xcpretty
        run: gem install --no-document xcpretty
      - name: Run macOS UI tests
        run: |
          set -o pipefail
          LOG="$GITHUB_WORKSPACE/xcodebuild-macos-ui.log"
          JUNIT="$GITHUB_WORKSPACE/macos-ui-tests.xml"
          if [ -f "Roots.xcworkspace" ]; then
            xcodebuild -workspace "Roots.xcworkspace" -scheme "Roots" -destination "platform=macOS" -only-testing:RootsUITests test | tee "$LOG" | xcpretty -r junit --output "$JUNIT"
          elif [ -f "Roots.xcodeproj" ]; then
            xcodebuild -project "Roots.xcodeproj" -scheme "Roots" -destination "platform=macOS" -only-testing:RootsUITests test | tee "$LOG" | xcpretty -r junit --output "$JUNIT"
          else
            echo "no project/workspace" && exit 1
          fi
      - name: Upload macOS UI artifacts (inline uploader)
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ART_NAME="macos-ui-logs-${GITHUB_RUN_ID}"
          TMPDIR="/tmp/${ART_NAME}"
          mkdir -p "$TMPDIR"
          cp -v "$GITHUB_WORKSPACE/xcodebuild-macos-ui.log" "$TMPDIR/" || true
          cp -v "$GITHUB_WORKSPACE/macos-ui-tests.xml" "$TMPDIR/" || true
          TAR="$TMPDIR/${ART_NAME}.tar.gz"
          tar -C "$TMPDIR" -czf "$TAR" . || true

          API_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/releases"
          DATA=$(jq -n --arg tag "artifact-${GITHUB_RUN_ID}-${ART_NAME}" --arg name "$ART_NAME" '{tag_name: $tag, name: $name, prerelease: true}')
          RESP=$(curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/json" -d "$DATA" "$API_URL")
          UPLOAD_URL=$(echo "$RESP" | python -c 'import sys, json; d=json.load(sys.stdin); print(d.get("upload_url",""))')
          if [ -z "$UPLOAD_URL" ]; then
            echo "Failed to create release; response:" >&2
            echo "$RESP" >&2
            exit 0
          fi
          UPLOAD_URL=${UPLOAD_URL/%\{?name,label\}/}
          BASENAME=$(basename "$TAR")
          curl --fail -s -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/gzip" --data-binary "@$TAR" "$UPLOAD_URL?name=$BASENAME" || true


  ios-ui:
    name: iOS UI Tests (Simulator)
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "Cloning repository into $GITHUB_WORKSPACE"
          rm -rf "$GITHUB_WORKSPACE"/* || true
          git clone --depth=1 "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" "$GITHUB_WORKSPACE"
          echo "Repository cloned."
      - name: Select Xcode
        run: |
          echo "Requested Xcode: latest-stable"
          echo "Available Xcode installs:"
          ls /Applications || true
          echo "xcode-select path: $(xcode-select -p)" || true
      - name: Install tools
        run: gem install --no-document xcpretty
      - name: Boot Simulator
        run: |
          xcrun simctl bootstatus "iPhone 14" -b || xcrun simctl boot "iPhone 14"
      - name: Run iOS UI tests
        run: |
          set -o pipefail
          LOG="$GITHUB_WORKSPACE/xcodebuild-ios-ui.log"
          JUNIT="$GITHUB_WORKSPACE/ios-ui-tests.xml"
          if [ -f "Roots.xcworkspace" ]; then
            xcodebuild -workspace "Roots.xcworkspace" -scheme "Roots-iOS" -destination "platform=iOS Simulator,name=iPhone 14" -only-testing:RootsUITests test | tee "$LOG" | xcpretty -r junit --output "$JUNIT"
          elif [ -f "Roots.xcodeproj" ]; then
            xcodebuild -project "Roots.xcodeproj" -scheme "Roots-iOS" -destination "platform=iOS Simulator,name=iPhone 14" -only-testing:RootsUITests test | tee "$LOG" | xcpretty -r junit --output "$JUNIT"
          else
            echo "no project/workspace" && exit 1
          fi
      - name: Upload iOS UI artifacts (inline uploader)
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ART_NAME="ios-ui-logs-${GITHUB_RUN_ID}"
          TMPDIR="/tmp/${ART_NAME}"
          mkdir -p "$TMPDIR"
          cp -v "$GITHUB_WORKSPACE/xcodebuild-ios-ui.log" "$TMPDIR/" || true
          cp -v "$GITHUB_WORKSPACE/ios-ui-tests.xml" "$TMPDIR/" || true
          TAR="$TMPDIR/${ART_NAME}.tar.gz"
          tar -C "$TMPDIR" -czf "$TAR" . || true

          API_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/releases"
          DATA=$(jq -n --arg tag "artifact-${GITHUB_RUN_ID}-${ART_NAME}" --arg name "$ART_NAME" '{tag_name: $tag, name: $name, prerelease: true}')
          RESP=$(curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/json" -d "$DATA" "$API_URL")
          UPLOAD_URL=$(echo "$RESP" | python -c 'import sys, json; d=json.load(sys.stdin); print(d.get("upload_url",""))')
          if [ -z "$UPLOAD_URL" ]; then
            echo "Failed to create release; response:" >&2
            echo "$RESP" >&2
            exit 0
          fi
          UPLOAD_URL=${UPLOAD_URL/%\{?name,label\}/}
          BASENAME=$(basename "$TAR")
          curl --fail -s -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/gzip" --data-binary "@$TAR" "$UPLOAD_URL?name=$BASENAME" || true
