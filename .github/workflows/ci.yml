name: Roots CI
permissions:
  contents: read

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: "0 7 * * *"

jobs:
  build-and-test:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "Cloning repository into $GITHUB_WORKSPACE"
          rm -rf "$GITHUB_WORKSPACE"/* || true
          git clone --depth=1 "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" "$GITHUB_WORKSPACE"
          echo "Repository cloned."

      - name: Select Xcode
        run: |
          echo "Requested Xcode: latest-stable"
          echo "Available Xcode installs:"
          ls /Applications || true
          echo "xcode-select path: $(xcode-select -p)" || true

      - name: Install dependencies
        run: |
          gem install --no-document xcpretty

      - name: Build and Test
        id: build
        run: |
          set -o pipefail
          LOG_FILE="$GITHUB_WORKSPACE/xcodebuild.log"
          JUNIT_FILE="$GITHUB_WORKSPACE/tests.xml"
          if [ -f "Roots.xcworkspace" ]; then
            xcodebuild -workspace "Roots.xcworkspace" -scheme "Roots" -destination "platform=macOS" clean test | tee "$LOG_FILE" | xcpretty -r junit --output "$JUNIT_FILE"
          elif [ -f "Roots.xcodeproj" ]; then
            xcodebuild -project "Roots.xcodeproj" -scheme "Roots" -destination "platform=macOS" clean test | tee "$LOG_FILE" | xcpretty -r junit --output "$JUNIT_FILE"
          else
            echo "No Roots.xcworkspace or Roots.xcodeproj found in repo root" >&2
            ls -la
            exit 1
          fi

      - name: Upload test artifacts (inline uploader)
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ART_NAME="xcodebuild-logs-${GITHUB_RUN_ID}"
          TMPDIR="/tmp/${ART_NAME}"
          mkdir -p "$TMPDIR"
          cp -v "$GITHUB_WORKSPACE/xcodebuild.log" "$TMPDIR/" || true
          cp -v "$GITHUB_WORKSPACE/tests.xml" "$TMPDIR/" || true
          TAR="$TMPDIR/${ART_NAME}.tar.gz"
          tar -C "$TMPDIR" -czf "$TAR" . || true

          API_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/releases"
          DATA=$(jq -n --arg tag "artifact-${GITHUB_RUN_ID}-${ART_NAME}" --arg name "$ART_NAME" '{tag_name: $tag, name: $name, prerelease: true}')
          RESP=$(curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/json" -d "$DATA" "$API_URL")
          UPLOAD_URL=$(echo "$RESP" | python -c 'import sys, json; d=json.load(sys.stdin); print(d.get("upload_url",""))')
          if [ -z "$UPLOAD_URL" ]; then
            echo "Failed to create release; response:" >&2
            echo "$RESP" >&2
            exit 0
          fi
          UPLOAD_URL=${UPLOAD_URL/%\{?name,label\}/}
          BASENAME=$(basename "$TAR")
          curl --fail -s -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/gzip" --data-binary "@$TAR" "$UPLOAD_URL?name=$BASENAME" || true

      - name: Fail on test failures
        if: always()
        run: |
          if [ -f "$GITHUB_WORKSPACE/tests.xml" ]; then
            if grep -q "failures=\"0\"" "$GITHUB_WORKSPACE/tests.xml"; then
              echo "No test failures"
            else
              echo "Tests reported failures"
              exit 1
            fi
          fi
